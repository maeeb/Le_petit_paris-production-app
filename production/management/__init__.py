# production/management/commands/setup_petit_paris_data.py
from django.core.management.base import BaseCommand
from django.contrib.auth.models import User
from django.utils import timezone
from production.models import LigneProduction, Produit, Equipe, ProductionRecord, Alerte


class Command(BaseCommand):
    help = 'Cr√©e les donn√©es de base compl√®tes pour Le Petit Paris'

    def handle(self, *args, **options):
        self.stdout.write("üöÄ Cr√©ation des donn√©es de base pour Le Petit Paris...")

        # ================================
        # 1. CR√âER LES LIGNES DE PRODUCTION
        # ================================
        self.stdout.write("\nüìã Cr√©ation des lignes de production...")

        # Supprimer les anciennes si elles existent (pour √©viter les doublons)
        LigneProduction.objects.all().delete()

        lignes_data = [
            {'numero': 1, 'nom': 'Ligne 1'},
            {'numero': 2, 'nom': 'Ligne 2'},
            {'numero': 3, 'nom': 'Ligne 3'},
        ]

        lignes = []
        for ligne_data in lignes_data:
            ligne = LigneProduction.objects.create(
                numero=ligne_data['numero'],
                nom=ligne_data['nom'],
                is_active=True
            )
            lignes.append(ligne)
            self.stdout.write(f"‚úÖ Cr√©√©: {ligne}")

        # ================================
        # 2. CR√âER LES PRODUITS
        # ================================
        self.stdout.write("\nü•´ Cr√©ation des produits...")

        # Supprimer les anciens produits
        Produit.objects.all().delete()

        # DCT - Double Concentr√© de Tomate
        produits_dct_data = [
            "DCT 5/1", "DCT 4/4", "DCT 1/2", "DCT 1/4", "DCT 1/6"
        ]
        produits_dct = []
        for nom in produits_dct_data:
            produit = Produit.objects.create(
                nom=nom,
                description=f"Double Concentr√© de Tomate - Bo√Æte {nom.split(' ')[1]}"
            )
            produits_dct.append(produit)

        # Tomate Concass√©e
        varietes_concassee = ['Ail', 'Basilic', 'Nature']
        formats_concassee = ['5/1', '3/1', '1/2']
        produits_concassee = []
        
        for variete in varietes_concassee:
            for format_boite in formats_concassee:
                if variete == 'Nature':
                    nom = f"Tomate Concass√©e Nature {format_boite}"
                    description = f"Tomate Concass√©e Nature - Bo√Æte {format_boite}"
                else:
                    nom = f"Tomate Concass√©e {variete} {format_boite}"
                    description = f"Tomate Concass√©e au {variete} - Bo√Æte {format_boite}"
                
                produit = Produit.objects.create(nom=nom, description=description)
                produits_concassee.append(produit)

        # Sauce Pizza
        formats_pizza = ['5/1', '3/1', '1/2']
        produits_sauce_pizza = []
        for format_boite in formats_pizza:
            produit = Produit.objects.create(
                nom=f"Sauce Pizza {format_boite}",
                description=f"Sauce Pizza - Bo√Æte {format_boite}"
            )
            produits_sauce_pizza.append(produit)

        # Confitures
        varietes_confiture = ['Pomme', 'Fraise', 'Figue', 'Abricot', 'Coing']
        formats_confiture = ['4/4', '1/2', '3/2']
        produits_confitures = []
        
        for variete in varietes_confiture:
            for format_boite in formats_confiture:
                nom = f"Confiture {variete} {format_boite}"
                description = f"Confiture de {variete} - Bo√Æte {format_boite}"
                produit = Produit.objects.create(nom=nom, description=description)
                produits_confitures.append(produit)

        # Harissa
        formats_harissa = ['3/1', '1/2', '1/6']
        produits_harissa = []
        for format_boite in formats_harissa:
            produit = Produit.objects.create(
                nom=f"Harissa {format_boite}",
                description=f"Harissa - Bo√Æte {format_boite}"
            )
            produits_harissa.append(produit)

        tous_produits = produits_dct + produits_concassee + produits_sauce_pizza + produits_confitures + produits_harissa

        self.stdout.write(f"\n‚úÖ Cr√©√© {len(tous_produits)} produits:")
        self.stdout.write(f"   üì¶ DCT: {len(produits_dct)} formats")
        self.stdout.write(f"   üçÖ Tomate Concass√©e: {len(produits_concassee)} vari√©t√©s/formats")
        self.stdout.write(f"   üçï Sauce Pizza: {len(produits_sauce_pizza)} formats")
        self.stdout.write(f"   üçì Confitures: {len(produits_confitures)} vari√©t√©s/formats")
        self.stdout.write(f"   üå∂Ô∏è Harissa: {len(produits_harissa)} formats")

        # ================================
        # 3. CR√âER LES UTILISATEURS OP√âRATEURS
        # ================================
        self.stdout.write("\nüë∑ Cr√©ation des utilisateurs op√©rateurs...")

        # Supprimer les anciens op√©rateurs s'ils existent
        User.objects.filter(username__startswith='operateur').delete()

        operateurs_data = [
            {
                'username': 'operateur1',
                'password': 'op123456',
                'first_name': 'Ahmed',
                'last_name': 'Ben Salah',
                'email': 'ahmed.bensalah@lepetitparis.com'
            },
            {
                'username': 'operateur2',
                'password': 'op123456',
                'first_name': 'Fatima',
                'last_name': 'Trabelsi',
                'email': 'fatima.trabelsi@lepetitparis.com'
            },
            {
                'username': 'operateur3',
                'password': 'op123456',
                'first_name': 'Mohamed',
                'last_name': 'Gharbi',
                'email': 'mohamed.gharbi@lepetitparis.com'
            }
        ]

        operateurs = []
        for op_data in operateurs_data:
            user = User.objects.create_user(
                username=op_data['username'],
                password=op_data['password'],
                first_name=op_data['first_name'],
                last_name=op_data['last_name'],
                email=op_data['email']
            )
            operateurs.append(user)
            self.stdout.write(f"‚úÖ Cr√©√© utilisateur: {user.username} ({user.first_name} {user.last_name})")

        # Cr√©er un admin si demand√©
        admin_user, created = User.objects.get_or_create(
            username='admin',
            defaults={
                'first_name': 'Admin',
                'last_name': 'Le Petit Paris',
                'email': 'admin@lepetitparis.com',
                'is_staff': True,
                'is_superuser': True,
            }
        )
        if created:
            admin_user.set_password('admin123')
            admin_user.save()
            self.stdout.write(f"‚úÖ Cr√©√© administrateur: {admin_user.username}")

        # ================================
        # 4. CR√âER LES √âQUIPES
        # ================================
        self.stdout.write("\n‚è∞ Cr√©ation des √©quipes de travail...")

        # Supprimer les anciennes √©quipes
        Equipe.objects.all().delete()

        equipes_data = [
            {'nom': '√âquipe du Matin', 'horaire': '6h-14h', 'operateur': operateurs[0]},
            {'nom': '√âquipe de l\'Apr√®s-midi', 'horaire': '14h-22h', 'operateur': operateurs[1]},
            {'nom': '√âquipe de Nuit', 'horaire': '22h-6h', 'operateur': operateurs[2]},
        ]

        equipes = []
        for equipe_data in equipes_data:
            equipe = Equipe.objects.create(
                nom=equipe_data['nom'],
                horaire=equipe_data['horaire'],
                operateur=equipe_data['operateur']
            )
            equipes.append(equipe)
            self.stdout.write(f"‚úÖ Cr√©√© √©quipe: {equipe}")

        # ================================
        # 5. CR√âER QUELQUES DONN√âES DE TEST
        # ================================
        self.stdout.write("\nüìä Cr√©ation de donn√©es de test...")

        # Cr√©er quelques enregistrements de production pour tester
        test_records = []

        # Production DCT sur Ligne 1
        test_record1 = ProductionRecord.objects.create(
            ligne_production=lignes[0],
            produit=produits_dct[0],  # DCT 5/1
            equipe=equipes[0],
            operateur=operateurs[0],
            palettes_produites=8,
            dechets_boites=3.2,
            duree_arret_minutes=0,
            commentaires="Production normale - DCT 5/1"
        )
        test_records.append(test_record1)

        # Production Tomate Concass√©e avec arr√™t
        test_record2 = ProductionRecord.objects.create(
            ligne_production=lignes[1],
            produit=produits_concassee[0],  # Tomate Concass√©e Ail 5/1
            equipe=equipes[1],
            operateur=operateurs[1],
            palettes_produites=6,
            dechets_boites=2.1,
            duree_arret_minutes=25,
            cause_arret="Nettoyage changement de produit",
            commentaires="Changement Basilic vers Ail"
        )
        test_records.append(test_record2)

        # Production Confiture
        test_record3 = ProductionRecord.objects.create(
            ligne_production=lignes[2],
            produit=produits_confitures[0],  # Confiture Pomme 4/4
            equipe=equipes[2],
            operateur=operateurs[2],
            palettes_produites=4,
            dechets_boites=1.8,
            duree_arret_minutes=0,
            commentaires="Production de nuit - Confiture pomme"
        )
        test_records.append(test_record3)

        for record in test_records:
            self.stdout.write(f"‚úÖ Cr√©√© enregistrement test: {record}")

        # Cr√©er une alerte pour l'arr√™t
        alerte_test = Alerte.objects.create(
            production_record=test_record2,
            type_alerte='arret',
            message=f"Arr√™t de {test_record2.duree_arret_minutes} minutes sur {test_record2.ligne_production}. Cause: {test_record2.cause_arret}"
        )

        self.stdout.write(f"‚úÖ Cr√©√© alerte test: {alerte_test}")

        # ================================
        # 6. R√âSUM√â
        # ================================
        self.stdout.write("\n" + "="*60)
        self.stdout.write("üéâ DONN√âES DE BASE CR√â√âES AVEC SUCC√àS!")
        self.stdout.write("="*60)

        self.stdout.write(f"\nüìã Lignes de production: {LigneProduction.objects.count()}")
        for ligne in LigneProduction.objects.all():
            self.stdout.write(f"   - {ligne}")

        self.stdout.write(f"\nü•´ Produits par cat√©gorie:")
        self.stdout.write(f"   üì¶ DCT: {len(produits_dct)} formats (5/1, 4/4, 1/2, 1/4, 1/6)")
        self.stdout.write(f"   üçÖ Tomate Concass√©e: {len(produits_concassee)} produits (Ail, Basilic, Nature)")
        self.stdout.write(f"   üçï Sauce Pizza: {len(produits_sauce_pizza)} formats (5/1, 3/1, 1/2)")
        self.stdout.write(f"   üçì Confitures: {len(produits_confitures)} produits (Pomme, Fraise, Figue, Abricot, Coing)")
        self.stdout.write(f"   üå∂Ô∏è Harissa: {len(produits_harissa)} formats (3/1, 1/2, 1/6)")
        self.stdout.write(f"   üìä TOTAL: {Produit.objects.count()} produits")

        self.stdout.write(f"\nüë∑ Op√©rateurs: {User.objects.filter(username__startswith='operateur').count()}")
        for user in User.objects.filter(username__startswith='operateur'):
            self.stdout.write(f"   - {user.username} ({user.first_name} {user.last_name})")

        self.stdout.write(f"\n‚è∞ √âquipes: {Equipe.objects.count()}")
        for equipe in Equipe.objects.all():
            self.stdout.write(f"   - {equipe}")

        self.stdout.write(f"\nüìä Enregistrements de test: {ProductionRecord.objects.count()}")
        self.stdout.write(f"üö® Alertes de test: {Alerte.objects.count()}")

        self.stdout.write("\n" + "="*60)
        self.stdout.write("INFORMATIONS DE CONNEXION:")
        self.stdout.write("="*60)
        self.stdout.write("üîë Op√©rateurs:")
        self.stdout.write("   - operateur1 / op123456 (Ahmed Ben Salah - √âquipe 6h-14h)")
        self.stdout.write("   - operateur2 / op123456 (Fatima Trabelsi - √âquipe 14h-22h)")
        self.stdout.write("   - operateur3 / op123456 (Mohamed Gharbi - √âquipe 22h-6h)")
        self.stdout.write("   - admin / admin123 (Administrateur)")
        self.stdout.write("\nüíª URL de l'application: http://127.0.0.1:8000/login/")
        
        self.stdout.write(
            self.style.SUCCESS("\n‚úÖ L'application est maintenant pr√™te pour la production agroalimentaire!")
        )