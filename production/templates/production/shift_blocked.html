<!-- production/templates/production/shift_blocked.html -->
{% extends 'production/base.html' %}
{% load static %}

{% block title %}Acc√®s Bloqu√© - Le Petit Paris{% endblock %}

{% block extra_css %}
<style>
    .blocked-container {
        min-height: 80vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .blocked-card {
        background: white;
        border-radius: 20px;
        padding: 3rem;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        max-width: 600px;
        width: 90%;
    }
    .blocked-icon {
        color: #dc3545;
        font-size: 5rem;
        margin-bottom: 1rem;
    }
    .current-time {
        font-size: 2.5rem;
        font-weight: bold;
        color: #007bff;
        margin: 1rem 0;
    }
    .shift-info {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin: 1.5rem 0;
    }
    .pulse {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    .debug-info {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 5px;
        padding: 10px;
        margin: 10px 0;
        font-family: monospace;
        font-size: 0.9em;
    }
</style>
{% endblock %}

{% block content %}
<div class="blocked-container">
    <div class="blocked-card">
        <div class="blocked-icon pulse">
            <i class="fas fa-lock"></i>
        </div>
        
        <h1 class="text-danger mb-3">Acc√®s Bloqu√©</h1>
        <p class="lead text-muted">Vous n'√™tes pas autoris√© √† acc√©der au syst√®me en ce moment</p>
        
        <div class="current-time" id="current-time">
            {{ current_hour }}h00
        </div>
        
        <!-- Debug info (√† retirer en production) -->
        <div class="debug-info" id="debug-info">
            <strong>Debug Info:</strong><br>
            Heure actuelle: <span id="debug-hour"></span><br>
            √âquipe utilisateur: "<span id="debug-shift"></span>"<br>
            Peut acc√©der: <span id="debug-access"></span><br>
            Status: <span id="debug-status">V√©rification...</span>
        </div>
        
        <div class="shift-info">
            <h4 class="text-primary">
                <i class="fas fa-users"></i> √âquipe Actuellement en Service
            </h4>
            <p class="fs-3 mb-0 text-success">{{ current_shift }}</p>
        </div>
        
        {% if user_shift %}
        <div class="shift-info">
            <h5 class="text-info">
                <i class="fas fa-user"></i> Votre √âquipe Assign√©e
            </h5>
            <p class="fs-4 mb-2">{{ user_shift }}</p>
            
            <div class="alert alert-info">
                <i class="fas fa-clock"></i>
                <strong>Votre prochain acc√®s :</strong> {{ user_next_access }}
            </div>
        </div>
        {% endif %}
        
        <div class="mt-4">
            <h6 class="text-muted">Horaires des √âquipes :</h6>
            <div class="row text-center mt-3">
                <div class="col-md-4">
                    <div class="badge bg-warning text-dark fs-6 p-2 mb-2">
                        <i class="fas fa-sun"></i><br>
                        Matin<br>
                        6h - 14h
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="badge bg-primary fs-6 p-2 mb-2">
                        <i class="fas fa-clock"></i><br>
                        Apr√®s-midi<br>
                        14h - 22h
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="badge bg-dark fs-6 p-2 mb-2">
                        <i class="fas fa-moon"></i><br>
                        Nuit<br>
                        22h - 6h
                    </div>
                </div>
            </div>
        </div>
        
        <hr class="my-4">
        
        <div class="d-flex justify-content-center gap-3">
            <a href="{% url 'logout' %}" class="btn btn-outline-secondary">
                <i class="fas fa-sign-out-alt"></i> Se D√©connecter
            </a>
            <button onclick="location.reload()" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i> Actualiser
            </button>
        </div>
        
        <div class="mt-4">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i>
                Cette page se rafra√Æchira automatiquement toutes les 60 secondes
            </small>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
console.log("Script de v√©rification d'acc√®s d√©marr√©");

// R√©cup√©rer l'horaire utilisateur depuis Django
const userShift = "{{ user.userprofile.horaire_equipe|default:'' }}";
console.log("√âquipe utilisateur r√©cup√©r√©e:", userShift);

// Remplacez la section de v√©rification dans votre template par ceci :

function updateTime() {
    const now = new Date();
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const seconds = now.getSeconds().toString().padStart(2, '0');
    
    document.getElementById('current-time').textContent = `${hours}:${minutes}:${seconds}`;
    
    const currentHour = now.getHours();
    let canAccess = false;
    let debugStatus = "V√©rification en cours...";
    
    // V√âRIFICATION EXACTE avec le format de la base de donn√©es
    if (userShift === '6-14' && currentHour >= 6 && currentHour < 14) {
        canAccess = true;
        debugStatus = "√âquipe matin OK (6-14)";
    } else if (userShift === '14-22' && currentHour >= 14 && currentHour < 22) {
        canAccess = true;
        debugStatus = "√âquipe apr√®s-midi OK (14-22)";
    } else if (userShift === '22-6' && (currentHour >= 22 || currentHour < 6)) {
        canAccess = true;
        debugStatus = "√âquipe nuit OK (22-6)";
    } else {
        debugStatus = `Pas d'acc√®s. Format: "${userShift}", Heure: ${currentHour}h`;
    }
    
    document.getElementById('debug-hour').textContent = currentHour;
    document.getElementById('debug-shift').textContent = userShift;
    document.getElementById('debug-access').textContent = canAccess ? 'OUI' : 'NON';
    document.getElementById('debug-status').textContent = debugStatus;
    
    console.log(`[${hours}:${minutes}:${seconds}] Heure: ${currentHour}, √âquipe: "${userShift}", Acc√®s: ${canAccess}`);
    
    if (canAccess) {
        console.log("üü¢ ACC√àS AUTORIS√â - Redirection...");
        setTimeout(() => {
            window.location.href = "{% url 'operator_dashboard' %}";
        }, 1000);
    }
}

// D√©marrer la v√©rification
console.log("D√©marrage des v√©rifications...");
updateTime(); // Appel imm√©diat
setInterval(updateTime, 1000); // Puis toutes les secondes

// Actualiser la page toutes les 60 secondes (backup)
setInterval(() => {
    console.log("Actualisation automatique de la page...");
    location.reload();
}, 60000);

// Message de bienvenue selon l'heure
document.addEventListener('DOMContentLoaded', function() {
    const currentHour = new Date().getHours();
    let greeting = "";
    
    if (currentHour >= 6 && currentHour < 12) {
        greeting = "Bonjour ! ";
    } else if (currentHour >= 12 && currentHour < 18) {
        greeting = "Bon apr√®s-midi ! ";
    } else {
        greeting = "Bonsoir ! ";
    }
    
    console.log(greeting + "Page de blocage d'acc√®s charg√©e");
    console.log("Informations utilisateur:", {
        shift: userShift,
        hour: currentHour
    });
});
</script>
{% endblock %}